(function () {
    'use strict';

    window.glob = async (pattern, options, callback) => {
        pattern = pattern.replace('ms-appdata:///local/','');
        const parts = pattern.split('/');
        const fileTypeFilter = parts.pop();
        const folderDepth = parts.pop();

        let queryOptions;
        if (fileTypeFilter === '*') {
            queryOptions = new Windows.Storage.Search.QueryOptions();
        } else {
            queryOptions = new Windows.Storage.Search.QueryOptions(Windows.Storage.Search.CommonFileQuery.orderByName, [fileTypeFilter.replace('*','')]);
        }
        if (folderDepth === '**') {
            queryOptions.folderDepth = Windows.Storage.Search.FolderDepth.deep;
        }

        const filePaths = [];
        const folder = await Windows.Storage.ApplicationData.current.localFolder.tryGetItemAsync(parts.join('/'));
        if (folder) {
            const query = folder.createFileQueryWithOptions(queryOptions);
            const files = await query.getFilesAsync();

            files.forEach(file => {
                if (options.nodir) {
                        filePaths.push(file.path.replace(Windows.Storage.ApplicationData.current.localFolder.path + '\\' + parts.join('\\') + '\\','').replace(/\\/g, '/'));
                    } else {
                        filePaths.push('ms-appdata:///local' + file.path.replace(Windows.Storage.ApplicationData.current.localFolder.path,'').replace(/\\/g, '/'));
                    }
            });
        }

        callback(null, filePaths);
    }
})();